version: '3.8'

services:
  app:
    image: ${DOCKER_REPOSITORY}:latest
    container_name: musee_transmitions_app
    restart: unless-stopped
    
    # Variables d'environnement SÉCURISÉES (lues depuis le fichier .env)
    environment:
      # Configuration de l'application
      APP_ENV: ${APP_ENV:-prod}
      APP_SECRET: ${APP_SECRET}
      
      # Configuration de la base de données
      DB_NAME: ${DB_NAME:-museeTransmitions}
      DB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      
      # URL de connexion Symfony (construite dynamiquement)
      DATABASE_URL: "mysql://root:${DB_ROOT_PASSWORD}@127.0.0.1:3306/${DB_NAME:-museeTransmitions}?serverVersion=mariadb-11.8.0&charset=utf8mb4"
      
      # CORS
      CORS_ALLOW_ORIGIN: ${CORS_ALLOW_ORIGIN:-^https?://(localhost|127\.0\.0\.1)(:[0-9]+)?$}
      
      # JWT (si tu utilises l'authentification)
      JWT_PASSPHRASE: ${JWT_PASSPHRASE}
    
    ports:
      # Front React sur port 80
      - "${FRONT_PORT:-80}:80"
      # API Symfony sur port 8080
      - "${API_PORT:-8080}:8080"
    
    volumes:
      # Persister les uploads (optionnel)
      - uploads_data:/var/www/html/public/uploads
      # Persister les données MariaDB
      - db_data:/var/lib/mysql
      # Logs (optionnel, pour debug)
      - ./logs:/var/www/html/var/log
    
    networks:
      - app_network
    
    # Healthcheck pour vérifier que l'app fonctionne
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

networks:
  app_network:
    driver: bridge

volumes:
  db_data:
    driver: local
  uploads_data:
    driver: local
